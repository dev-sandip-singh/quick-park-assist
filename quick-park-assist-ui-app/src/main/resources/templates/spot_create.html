<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Add Spot</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
      rel="stylesheet"
    />
    <style>
      /* Global Styles */
      :root {
        --primary-color: #4361ee;
        --secondary-color: #3f37c9;
        --accent-color: #4895ef;
        --success-color: #4cc9f0;
        --light-bg: #f8f9fa;
        --dark-text: #2b2d42;
        --transition-speed: 0.3s;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
      }

      .mybody {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: 40px 20px;
      }

      .container {
        width: 100%;
        padding: 0;
        max-width: 800px;
        background: #fff;
        border-radius: 20px;
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        position: relative;
      }

      .form-header {
        background: var(--primary-color);
        color: white;
        padding: 25px 40px;
        border-radius: 20px 20px 0 0;
        position: relative;
      }

      .form-header h1 {
        margin-bottom: 0;
        font-size: 28px;
        font-weight: 600;
      }

      .form-header p {
        margin-top: 5px;
        opacity: 0.8;
        font-size: 16px;
      }

      .form-container {
        padding: 30px 40px;
        max-height: 70vh;
        overflow-y: auto;
        scrollbar-width: thin;
      }

      .form-container::-webkit-scrollbar {
        width: 6px;
      }

      .form-container::-webkit-scrollbar-thumb {
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 3px;
      }

      .form-progress {
        display: flex;
        justify-content: space-between;
        margin-bottom: 30px;
        position: relative;
        z-index: 1;
      }

      .progress-step {
        flex: 1;
        text-align: center;
        position: relative;
      }

      .step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: var(--light-bg);
        color: var(--dark-text);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 8px;
        font-weight: bold;
        position: relative;
        z-index: 2;
        transition: all var(--transition-speed);
        border: 2px solid #ddd;
      }

      .progress-step.active .step-number {
        background-color: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
      }

      .progress-step.completed .step-number {
        background-color: var(--success-color);
        color: white;
        border-color: var(--success-color);
      }

      .step-label {
        font-size: 14px;
        color: var(--dark-text);
        font-weight: 500;
      }

      .progress-bar {
        position: absolute;
        top: 20px;
        left: 0;
        height: 2px;
        background-color: #ddd;
        width: 100%;
        z-index: 1;
      }

      .progress-bar-fill {
        height: 100%;
        background-color: var(--success-color);
        width: 0%;
        transition: width var(--transition-speed);
      }

      .form-step {
        display: none;
      }

      .form-step.active {
        display: block;
        animation: fadeIn 0.5s;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .section-title {
        font-size: 20px;
        font-weight: 600;
        color: var(--dark-text);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
      }

      .section-title i {
        margin-right: 10px;
        color: var(--primary-color);
        font-size: 24px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        font-weight: 500;
        display: block;
        margin-bottom: 8px;
        color: var(--dark-text);
        font-size: 15px;
      }

      .form-control {
        height: 48px;
        border-radius: 8px;
        border: 2px solid #e1e5eb;
        padding: 0 15px;
        font-size: 15px;
        transition: all var(--transition-speed);
      }

      .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
      }

      .select2-container--default .select2-selection--single {
        height: 48px;
        border-radius: 8px;
        border: 2px solid #e1e5eb;
        display: flex;
        align-items: center;
        padding: 0 15px;
      }

      .select2-container--default
        .select2-selection--single
        .select2-selection__arrow {
        height: 46px;
      }

      .select2-container--default
        .select2-results__option--highlighted[aria-selected] {
        background-color: var(--primary-color);
      }

      .form-row {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
      }

      .form-row .form-group {
        flex: 1;
        margin-bottom: 0;
      }

      .checkbox-group {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
      }

      .checkbox-group input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
      }

      .checkbox-group label {
        margin-left: 10px;
        margin-bottom: 0;
        cursor: pointer;
      }

      .vehicle-container {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-top: 10px;
      }

      .vehicle-item {
        position: relative;
      }

      .vehicle-item input[type="checkbox"] {
        position: absolute;
        opacity: 0;
        cursor: pointer;
      }

      .vehicle-item label {
        background-color: #f0f0f0;
        padding: 10px 15px;
        border-radius: 50px;
        display: inline-block;
        cursor: pointer;
        transition: all var(--transition-speed);
        margin-bottom: 0;
        font-weight: normal;
        color: #555;
      }

      .vehicle-item input[type="checkbox"]:checked ~ label {
        background-color: var(--primary-color);
        color: white;
      }

      .image-upload-container {
        border: 2px dashed #e1e5eb;
        border-radius: 10px;
        padding: 30px;
        text-align: center;
        cursor: pointer;
        transition: all var(--transition-speed);
        position: relative;
      }

      .image-upload-container:hover {
        border-color: var(--primary-color);
        background-color: rgba(67, 97, 238, 0.05);
      }

      .image-upload-container i {
        font-size: 48px;
        color: #ccc;
        margin-bottom: 15px;
        transition: all var(--transition-speed);
      }

      .image-upload-container:hover i {
        color: var(--primary-color);
      }

      #removeImage {
        margin-top: 10px;
        font-size: 14px;
        padding: 5px 10px;
      }

      .image-upload-container p {
        color: #777;
        margin-bottom: 5px;
      }

      .image-upload-container small {
        color: #999;
      }

      .image-preview {
        display: none;
        margin-top: 20px;
        text-align: center;
        position: relative;
      }

      .image-preview img {
        max-width: 100%;
        max-height: 200px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        object-fit: contain;
      }

      .btn-navigation {
        display: flex;
        justify-content: space-between;
        margin-top: 30px;
      }

      .btn {
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 500;
        border-radius: 8px;
        transition: all var(--transition-speed);
      }

      .btn-prev {
        background-color: #f0f0f0;
        color: var(--dark-text);
        border: none;
        padding: 0 20px;
      }

      .btn-prev:hover {
        background-color: #e0e0e0;
        color: var(--dark-text);
      }

      .btn-next,
      .btn-submit {
        background-color: var(--primary-color);
        color: white;
        border: none;
        padding: 0 25px;
      }

      .btn-next:hover,
      .btn-submit:hover {
        background-color: var(--secondary-color);
        color: white;
      }

      .btn i {
        margin-right: 8px;
      }

      .summary-section {
        background-color: var(--light-bg);
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .summary-section h3 {
        font-size: 18px;
        margin-bottom: 15px;
        color: var(--dark-text);
      }

      .summary-row {
        display: flex;
        margin-bottom: 10px;
      }

      .summary-label {
        width: 40%;
        font-weight: 500;
        color: #666;
      }

      .summary-value {
        width: 60%;
        font-weight: 400;
      }

      .summary-vehicle-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      .summary-vehicle-tag {
        background-color: var(--primary-color);
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 14px;
      }

      @media (max-width: 768px) {
        .form-row {
          flex-direction: column;
          gap: 15px;
        }

        .form-container {
          padding: 20px;
        }

        .form-header {
          padding: 20px;
        }
      }

      /* Improved Toggle Switch for EV Charging */
      .switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 34px;
        margin-right: 15px;
      }

      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 34px;
      }

      .slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }

      input:checked ~ .slider {
        background-color: var(--success-color);
      }

      input:focus ~ .slider {
        box-shadow: 0 0 1px var(--success-color);
      }

      input:checked ~ .slider:before {
        transform: translateX(26px);
      }

      .ev-toggle-container {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
      }

      .ev-toggle-label {
        font-weight: 500;
        color: var(--dark-text);
      }

      .last-location-toggle {
        display: flex;
        align-items: center;
        margin-top: 10px;
      }
  
      .last-location-toggle input[type="checkbox"] {
        margin-right: 10px;
      }
	  
	  /* Position the circular button on the top-left */
	  .left-arrow {
	  position: fixed;
	  top: 90px; /* Distance from the top */
	  left: 20px; /* Distance from the left */
	  width: 50px; /* Circle size */
	  height: 50px;
	  background-color: rgb(0, 0, 128); /* Blue background */
	  color: white; /* Arrow color */
	  font-size: 24px; /* Arrow size */
	  display: flex;
	  align-items: center;
	  justify-content: center;
	  border-radius: 50%; /* Makes it a circle */
	  text-decoration: none;
	  transition: background-color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;

	  /* Add shadow effect */
	  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
	  }

	  /* Hover effect */
	  .left-arrow:hover {
	  background-color: #0056b3; /* Darker blue */
	  color: white;
	  transform: scale(1.1); /* Slight zoom */
	  /* Add glowing effect */
	  box-shadow: 0 6px 15px rgba(0, 91, 187, 0.6);
	  text-decoration: none;
	  }



    </style>
  </head>
  <body>
    <div th:replace="~{fragments/navbarLanding :: navbarLanding}"></div>
	
	<a href="/spots/search" class="left-arrow">
		<i class="fas fa-arrow-left"></i>
	</a>

    <div class="mybody">
      <div class="container">
        <div class="form-header">
          <h1>Create Your Parking Spot</h1>
          <p>Share your space and start earning</p>
        </div>

        <div class="form-container">
          <!-- Progress Bar -->
          <div class="form-progress">
            <div class="progress-bar">
              <div class="progress-bar-fill" id="progressBar"></div>
            </div>

            <div class="progress-step active" data-step="1">
              <div class="step-number">1</div>
              <div class="step-label">Basic Info</div>
            </div>

            <div class="progress-step" data-step="2">
              <div class="step-number">2</div>
              <div class="step-label">Location</div>
            </div>

            <div class="progress-step" data-step="3">
              <div class="step-number">3</div>
              <div class="step-label">Vehicle Types</div>
            </div>

            <div class="progress-step" data-step="4">
              <div class="step-number">4</div>
              <div class="step-label">Photos</div>
            </div>

            <div class="progress-step" data-step="5">
              <div class="step-number">5</div>
              <div class="step-label">Review</div>
            </div>
          </div>

          <form
            th:action="@{/spots/create}"
            th:object="${spotCreateDTO}"
            method="post"
            enctype="multipart/form-data"
            id="spotForm"
          >
            <!-- Step 1: Basic Information -->
            <div class="form-step active" id="step1">
              <div class="section-title">
                <i class="fas fa-info-circle"></i> Basic Information
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="spotNumber">Spot Number/Name</label>
                  <input
                    type="text"
                    id="spotNumber"
                    th:field="*{spotNumber}"
                    class="form-control"
                    placeholder="E.g. A-15 or 'My Driveway'"
                    required
                  />
                </div>

                <div class="form-group">
                  <label for="spotType">Spot Type</label>
                  <select
                    id="spotType"
                    th:field="*{spotType}"
                    class="form-control"
                    required
                  >
                    <option value="">-- Select Spot Type --</option>
                    <option
                      th:each="type : ${spotTypes}"
                      th:value="${type}"
                      th:text="${type}"
                    ></option>
                  </select>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="priceType">Price Type</label>
                  <select
                    id="priceType"
                    th:field="*{priceType}"
                    class="form-control"
                    required
                  >
                    <option value="">-- Select Price Type --</option>
                    <option
                      th:each="type : ${priceTypes}"
                      th:value="${type}"
                      th:text="${type}"
                    ></option>
                  </select>
                </div>

                <div class="form-group" id="priceContainer">
                  <label for="price">Price (₹)</label>
                  <input
                    type="number"
                    id="price"
                    th:field="*{price}"
                    step="0.01"
                    class="form-control"
                    placeholder="0.00"
                  />
                </div>
              </div>

              <div class="ev-toggle-container">
                <label class="switch">
                  <input
                    type="checkbox"
                    id="hasEVCharging"
                    th:field="*{hasEVCharging}"
                  />
                  <span class="slider"></span>
                </label>
                <span class="ev-toggle-label"
                  >Electric Vehicle Charging Available</span
                >
              </div>

              <div class="btn-navigation">
                <div></div>
                <!-- Empty div to maintain flex spacing -->
                <button type="button" class="btn btn-next" id="next1">
                  <i class="fas fa-arrow-right"></i> Next: Location
                </button>
              </div>
            </div>

            <!-- Step 2: Location -->
            <div class="form-step" id="step2">
              <div class="section-title">
                <i class="fas fa-map-marker-alt"></i> Location Details
              </div>

              <div class="form-group">
                <div class="last-location-toggle">
                  <input 
                    type="checkbox" 
                    id="sameAsLastLocation" 
                    name="sameAsLastLocation"
                  />
                  <label for="sameAsLastLocation">
                    Same as Last Location
                  </label>
                </div>
              </div>

              <div class="form-group">
                <label for="location.streetAddress">Street Address</label>
                <input
                  type="text"
                  id="location.streetAddress"
                  th:field="*{location.streetAddress}"
                  class="form-control"
                  placeholder="Enter full street address"
                  required
                />
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="stateSelect">State/Province</label>
                  <select id="stateSelect" class="form-control" required>
                    <option value="">-- Select State --</option>
                    <option
                      th:each="state : ${states}"
                      th:value="${state}"
                      th:text="${state}"
                    ></option>
                  </select>
                  <input
                    type="hidden"
                    id="location.state"
                    th:field="*{location.state}"
                  />
                </div>

                <div class="form-group">
                  <label for="citySelect">City</label>
                  <select id="citySelect" class="form-control" required>
                    <option value="">-- Select State First --</option>
                  </select>
                  <input
                    type="hidden"
                    id="location.city"
                    th:field="*{location.city}"
                  />
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label for="location.pincode">Pin Code/ZIP</label>
                  <input
                    type="text"
                    id="location.pincode"
                    th:field="*{location.pincode}"
                    class="form-control"
                    readonly
                  />
                </div>
  
                <div class="form-group">
                  <label for="location.landmark">Landmark</label>
                  <input 
                    type="text"
                    id="location.landmark"
                    th:field="*{location.landmark}"
                    class="form-control"
                    placeholder="Leave empty if needed"
                  />
                </div>
              </div>

              <div class="btn-navigation">
                <button type="button" class="btn btn-prev" id="prev2">
                  <i class="fas fa-arrow-left"></i> Previous
                </button>
                <button type="button" class="btn btn-next" id="next2">
                  <i class="fas fa-arrow-right"></i> Next: Vehicles
                </button>
              </div>
            </div>

            <!-- Step 3: Vehicle Types -->
            <div class="form-step" id="step3">
              <div class="section-title">
                <i class="fas fa-car"></i> Supported Vehicle Types
              </div>

              <p class="mb-4">
                Select all vehicle types that can use this parking spot:
              </p>

              <div class="vehicle-container">
                <div
                  th:each="vehicleType : ${vehicleTypes}"
                  class="vehicle-item"
                >
                  <input
                    type="checkbox"
                    th:field="*{supportedVehicle}"
                    th:value="${vehicleType}"
                    th:id="${'vehicle-' + vehicleType}"
                  />
                  <label
                    th:for="${'vehicle-' + vehicleType}"
                    th:text="${vehicleType}"
                  ></label>
                </div>
              </div>

              <div class="btn-navigation">
                <button type="button" class="btn btn-prev" id="prev3">
                  <i class="fas fa-arrow-left"></i> Previous
                </button>
                <button type="button" class="btn btn-next" id="next3">
                  <i class="fas fa-arrow-right"></i> Next: Photos
                </button>
              </div>
            </div>

            <!-- Step 4: Image Upload -->
            <div class="form-step" id="step4">
              <div class="section-title">
                <i class="fas fa-image"></i> Spot Photos
              </div>

              <p class="mb-4">
                A good photo helps renters see exactly what they're getting.
                Show off your spot!
              </p>

              <div class="image-upload-container" id="imageUploadContainer">
                <i class="fas fa-cloud-upload-alt"></i>
                <p>Drag & drop your photo here</p>
                <small>or click to browse files (JPG, PNG)</small>
                <input
                  type="file"
                  id="spotImage"
                  name="imageFile"
                  accept="image/*"
                  class="form-control d-none"
                />
              </div>

              <div class="image-preview" id="imagePreview">
                <img src="#" alt="Preview" />
              </div>

              <div class="btn-navigation">
                <button type="button" class="btn btn-prev" id="prev4">
                  <i class="fas fa-arrow-left"></i> Previous
                </button>
                <button type="button" class="btn btn-next" id="next4">
                  <i class="fas fa-arrow-right"></i> Review
                </button>
              </div>
            </div>

            <!-- Step 5: Review Information -->
            <div class="form-step" id="step5">
              <div class="section-title">
                <i class="fas fa-check-circle"></i> Review Your Spot
              </div>

              <p class="mb-4">
                Please review all information before submitting:
              </p>

              <div class="summary-section">
                <h3>Basic Information</h3>
                <div class="summary-row">
                  <div class="summary-label">Spot Number/Name:</div>
                  <div class="summary-value" id="summary-spot-number"></div>
                </div>
                <div class="summary-row">
                  <div class="summary-label">Spot Type:</div>
                  <div class="summary-value" id="summary-spot-type"></div>
                </div>
                <div class="summary-row">
                  <div class="summary-label">Price:</div>
                  <div class="summary-value" id="summary-price"></div>
                </div>
                <div class="summary-row">
                  <div class="summary-label">EV Charging:</div>
                  <div class="summary-value" id="summary-ev-charging"></div>
                </div>
              </div>

              <div class="summary-section">
                <h3>Location</h3>
                <div class="summary-row">
                  <div class="summary-label">Address:</div>
                  <div class="summary-value" id="summary-address"></div>
                </div>
                <div class="summary-row">
                  <div class="summary-label">Landmark:</div>
                  <div class="summary-value" id="summary-landmark"></div>
                </div>
                <div class="summary-row">
                  <div class="summary-label">City:</div>
                  <div class="summary-value" id="summary-city"></div>
                </div>
                <div class="summary-row">
                  <div class="summary-label">State:</div>
                  <div class="summary-value" id="summary-state"></div>
                </div>
                <div class="summary-row">
                  <div class="summary-label">Pin Code:</div>
                  <div class="summary-value" id="summary-pincode"></div>
                </div>
              </div>

              <div class="summary-section">
                <h3>Supported Vehicles</h3>
                <div class="summary-vehicle-tags" id="summary-vehicles">
                  <!-- Vehicle tags will be added here dynamically -->
                </div>
              </div>

              <div class="btn-navigation">
                <button type="button" class="btn btn-prev" id="prev5">
                  <i class="fas fa-arrow-left"></i> Previous
                </button>
                <button type="submit" class="btn btn-submit">
                  <i class="fas fa-check"></i> Create Spot
                </button>
              </div>
            </div>
          </form>

          <div
            th:if="${error}"
            class="error-message mt-3 p-3 bg-danger text-white rounded"
          >
            <p th:text="${error}" class="mb-0"></p>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script th:inline="javascript">
      const stateCityMap = /*[[${stateCityMap}]]*/ {};
      const cityPincodeMap = /*[[${cityPincodeMap}]]*/ {};

      function initImageUpload() {
        const imageUploadContainer = document.getElementById(
          "imageUploadContainer"
        );
        const imagePreview = document.getElementById("imagePreview");
        const imagePreviewImg = document.querySelector("#imagePreview img");
        const spotImage = document.getElementById("spotImage");

        // Handle click on the container (without creating infinite loops)
        imageUploadContainer.addEventListener("click", function (e) {
          // Prevent click propagation if we're clicking on a child element
          if (e.target !== this && !this.contains(e.target)) return;

          // If we clicked directly on the container or its direct children, trigger the file input
          spotImage.click();
        });

        // Handle file selection
        spotImage.addEventListener("change", function () {
          const file = this.files[0];
          if (file) {
            displaySelectedImage(file);
          }
        });

        // Drag and drop functionality
        imageUploadContainer.addEventListener("dragover", function (e) {
          e.preventDefault();
          e.stopPropagation();
          this.style.borderColor = "var(--primary-color)";
          this.style.backgroundColor = "rgba(67, 97, 238, 0.05)";
        });

        imageUploadContainer.addEventListener("dragleave", function (e) {
          e.preventDefault();
          e.stopPropagation();
          this.style.borderColor = "";
          this.style.backgroundColor = "";
        });

        imageUploadContainer.addEventListener("drop", function (e) {
          e.preventDefault();
          e.stopPropagation();
          this.style.borderColor = "";
          this.style.backgroundColor = "";

          const dt = e.dataTransfer;
          const file = dt.files[0];

          if (file && file.type.match("image.*")) {
            spotImage.files = dt.files;
            displaySelectedImage(file);
          }
        });

        // Helper function to display the selected image
        function displaySelectedImage(file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            imagePreviewImg.src = e.target.result;
            imagePreview.style.display = "block";

            // Add a remove button
            if (!document.getElementById("removeImage")) {
              const removeBtn = document.createElement("button");
              removeBtn.id = "removeImage";
              removeBtn.className = "btn btn-sm btn-danger mt-2";
              removeBtn.innerHTML = '<i class="fas fa-times"></i> Remove Image';
              removeBtn.addEventListener("click", function (e) {
                e.preventDefault();
                e.stopPropagation();
                imagePreview.style.display = "none";
                imagePreviewImg.src = "#";
                spotImage.value = "";
                this.remove();
              });
              imagePreview.appendChild(removeBtn);
            }
          };
          reader.readAsDataURL(file);
        }
      }

      $(document).ready(function () {

        initImageUpload();

        // Initialize Select2
        $("#stateSelect, #citySelect, #spotType, #priceType").select2({
          width: "100%",
          dropdownParent: $(".form-container"),
        });

        // Multi-step form navigation
        let currentStep = 1;
        // Track the last used location
        const lastUsedLocation = /*[[${lastUsedLocation}]]*/ null;
        updateProgressBar(currentStep);

        // Next button handlers
        $("#next1").click(function () {
          if (validateStep(1)) {
            goToStep(2);
          }
        });

        $("#next2").click(function () {
          if (validateStep(2)) {
            goToStep(3);
          }
        });

        $("#next3").click(function () {
          if (validateStep(3)) {
            goToStep(4);
          }
        });

        $("#next4").click(function () {
          if (validateStep(4)) {
            updateSummary();
            goToStep(5);
          }
        });

        // Previous button handlers
        $("#prev2").click(function () {
          goToStep(1);
        });

        $("#prev3").click(function () {
          goToStep(2);
        });

        $("#prev4").click(function () {
          goToStep(3);
        });

        $("#prev5").click(function () {
          goToStep(4);
        });

        $('.vehicle-item input[type="checkbox"]').change(function () {
          if ($(this).is(":checked")) {
            $(this).next("label").css({
              "background-color": "var(--primary-color)",
              color: "white",
            });
          } else {
            $(this).next("label").css({
              "background-color": "#f0f0f0",
              color: "#555",
            });
          }
        });

        // Also initialize the styling for any pre-checked boxes
        $('.vehicle-item input[type="checkbox"]:checked').each(function () {
          $(this).next("label").css({
            "background-color": "var(--primary-color)",
            color: "white",
          });
        });

        // Function to validate each step
        function validateStep(step) {
          let isValid = true;

          if (step === 1) {
            if (!$("#spotNumber").val()) {
              markInvalid("#spotNumber");
              isValid = false;
            }

            if (!$("#spotType").val()) {
              markInvalid("#spotType");
              isValid = false;
            }

            if (!$("#priceType").val()) {
              markInvalid("#priceType");
              isValid = false;
            }

            if ($("#priceType").val() && !$("#price").val()) {
              markInvalid("#price");
              isValid = false;
            }
          }

          if (step === 2) {
            if (!$("#location\\.streetAddress").val()) {
              markInvalid("#location\\.streetAddress");
              isValid = false;
            }

            if (!$("#stateSelect").val()) {
              markInvalid("#stateSelect");
              isValid = false;
            }

            if (!$("#citySelect").val()) {
              markInvalid("#citySelect");
              isValid = false;
            }
          }

          if (step === 3) {
            if ($('input[name="supportedVehicle"]:checked').length === 0) {
              alert("Please select at least one vehicle type");
              isValid = false;
            }
          }

          return isValid;
        }

        function markInvalid(selector) {
          $(selector).addClass("is-invalid").css("border-color", "red");
          $(selector).one("focus", function () {
            $(this).removeClass("is-invalid").css("border-color", "");
          });
        }

        // Function to go to a specific step
        function goToStep(step) {
          $(".form-step").removeClass("active");
          $(`#step${step}`).addClass("active");

          // Update progress steps
          $(".progress-step").removeClass("active completed");
          $(`.progress-step[data-step="${step}"]`).addClass("active");

          for (let i = 1; i < step; i++) {
            $(`.progress-step[data-step="${i}"]`).addClass("completed");
          }

          currentStep = step;
          updateProgressBar(step);
        }

        // Update progress bar
        function updateProgressBar(step) {
          const stepWeights = [0, 30, 50, 70, 100];
          $("#progressBar").css("width", `${stepWeights[step - 1]}%`);
        }

        // Update summary information
        function updateSummary() {
          $("#summary-spot-number").text($("#spotNumber").val());
          $("#summary-spot-type").text($("#spotType").val());
          $("#summary-price").text(
            `₹${$("#price").val()} (${$("#priceType").val()})`
          );
          $("#summary-ev-charging").text(
            $("#hasEVCharging").is(":checked") ? "Yes" : "No"
          );

          $("#summary-address").text($("#location\\.streetAddress").val());
          $("#summary-city").text($("#citySelect").val());
          $("#summary-state").text($("#stateSelect").val());
          $("#summary-pincode").text($("#location\\.pincode").val());
          $("#summary-landmark").text($("#location\\.landmark").val() == "" ? "No Landmark Given" : $("#location\\.landmark").val());

          // Clear existing vehicle tags
          $("#summary-vehicles").empty();

          // Add vehicle tags for each selected vehicle
          $('input[name="supportedVehicle"]:checked').each(function () {
            const vehicleType = $(this).val();
            $("#summary-vehicles").append(
              `<span class="summary-vehicle-tag">${vehicleType}</span>`
            );
          });
        }

        // State & City dropdown dependency
        $("#stateSelect").change(function () {
          const selectedState = $(this).val();
          $("#location\\.state").val(selectedState);

          // Clear city dropdown
          $("#citySelect")
            .empty()
            .append('<option value="">-- Select City --</option>');

          // Populate cities based on selected state
          if (selectedState && stateCityMap[selectedState]) {
            const cities = stateCityMap[selectedState];
            cities.forEach((city) => {
              $("#citySelect").append(
                `<option value="${city}">${city}</option>`
              );
            });
          }

          // Reset pincode
          $("#location\\.pincode").val("");
        });

        // City & Pincode dependency
        $("#citySelect").change(function () {
          const selectedCity = $(this).val();
          $("#location\\.city").val(selectedCity);

          // Set pincode based on selected city
          if (selectedCity && cityPincodeMap[selectedCity]) {
            $("#location\\.pincode").val(cityPincodeMap[selectedCity]);
          } else {
            $("#location\\.pincode").val("");
          }
        });

        if (lastUsedLocation) {
          $('#sameAsLastLocation').prop('checked', true);
          
          // Populate location fields
          $('#location\\.streetAddress').val(lastUsedLocation.streetAddress || '');
          
          if (lastUsedLocation.state) {
              $('#stateSelect').val(lastUsedLocation.state).trigger('change');
              
              // Wait for cities to populate, then set city
              setTimeout(() => {
                  if (lastUsedLocation.city) {
                      $('#citySelect').val(lastUsedLocation.city).trigger('change');
                  }
              }, 100);
          }
          
          $('#location\\.landmark').val(lastUsedLocation.landmark || '');
          $('#location\\.pincode').val(lastUsedLocation.pincode || '');
        }

        // Optional: Add a button to clear last location
        $('#clearLastLocation').click(function() {
            window.location.href = '/spots/clear-last-location';
        });

        // Existing code for "Same as Last Location" checkbox remains the same
        $('#sameAsLastLocation').change(function() {
            if (!$(this).is(':checked')) {
                // Clear all location fields when unchecked
                $('#location\\.streetAddress').val('');
                $('#stateSelect').val('').trigger('change');
                $('#location\\.landmark').val('');
                $('#location\\.pincode').val('');
            }
        });

        // Before form submission, store the current location
        $('form').on('submit', function() {
          lastUsedLocation = {
            streetAddress: $('#location\\.streetAddress').val(),
            state: $('#stateSelect').val(),
            city: $('#citySelect').val(),
            pincode: $('#location\\.pincode').val(),
            landmark: $('#location\\.landmark').val()
          };
        });

        // Add event listener for "Same as Last Location" checkbox
        $('#sameAsLastLocation').change(function() {
          if ($(this).is(':checked') && lastUsedLocation) {
            // Populate form with last used location
            $('#location\\.streetAddress').val(lastUsedLocation.streetAddress);
            
            // Trigger state select change to populate cities
            $('#stateSelect').val(lastUsedLocation.state).trigger('change');
            
            // Wait for cities to populate, then set city
            setTimeout(() => {
              $('#citySelect').val(lastUsedLocation.city).trigger('change');
            }, 100);
            
            $('#location\\.landmark').val(lastUsedLocation.landmark);
          } else {
            // Clear form if unchecked
            $('#location\\.streetAddress').val('');
            $('#stateSelect').val('').trigger('change');
            $('#location\\.landmark').val('');
          }
        });
      });
	  
    </script>
  </body>
</html>
